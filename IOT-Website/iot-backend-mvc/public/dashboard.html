<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - IoT Monitoring</title>

    <link rel="stylesheet" href="assets/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>

<body>

    <div class="main-content">
        <div class="page active">
            <h1 class="page-title" style="margin-bottom: 2rem;">IoT Sensor Dashboard</h1>

            <!-- Alert Controls -->
            <div style="margin-bottom: 1rem; text-align: right;">
                <button id="muteBtn" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    ğŸ”Š Sound: ON
                </button>
            </div>

            <!-- Alert Toast Notification -->
            <div id="alertToast" style="display: none; position: fixed; top: 20px; right: 20px; background: #ff4444; color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); z-index: 10000; max-width: 400px;">
                <div style="font-weight: bold; font-size: 18px; margin-bottom: 10px;" id="alertToastTitle">ğŸš¨ Alert</div>
                <div id="alertToastMessage"></div>
                <button onclick="document.getElementById('alertToast').style.display='none'" style="margin-top: 10px; padding: 5px 10px; background: rgba(255,255,255,0.3); border: none; color: white; border-radius: 4px; cursor: pointer;">Dismiss</button>
            </div>

            <!-- Sensor Cards -->
            <div class="dashboard-grid">
                <div class="card sensor-card" id="tempCard">
                    <div class="sensor-info">
                        <h3>Temperature</h3>
                        <div class="sensor-value" id="tempValue">-- Â°C</div>
                    </div>
                    <div class="sensor-icon">ğŸŒ¡ï¸</div>
                </div>

                <div class="card sensor-card" id="humidCard">
                    <div class="sensor-info">
                        <h3>Humidity</h3>
                        <div class="sensor-value" id="humidValue">-- %</div>
                    </div>
                    <div class="sensor-icon">ğŸ’§</div>
                </div>
            </div>

            <!-- Chart -->
            <div class="chart-container">
                <h3 class="chart-title">Sensor Readings Over Time</h3>
                <canvas id="sensorChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // ========= State =========
        let chart;
        let labels = [];
        let tempData = [];
        let humidData = [];
        const MAX_CHART_POINTS = 50; // Keep last 50 points for smooth scrolling
        
        // In-memory statistics
        const stats = {
            temp: {
                current: null,
                min: null,
                max: null,
                values: []
            },
            humid: {
                current: null,
                min: null,
                max: null,
                values: []
            }
        };
        
        // Alert system state
        let soundEnabled = true;
        let audioContext = null;
        
        // Initialize Web Audio API for beep sound
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }
        
        // Generate and play beep sound
        function playAlertBeep() {
            if (!soundEnabled) return;
            
            try {
                const ctx = initAudioContext();
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                oscillator.frequency.value = 800; // 800 Hz beep
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.3);
            } catch (err) {
                console.warn('[ALERT] Sound play failed:', err);
            }
        }
        
        // Socket.IO connection
        const socket = io();

        // ========= Update Cards =========
        function updateCards(data) {
            if (!data) return;

            if (data.temperature != null) {
                document.getElementById("tempValue").innerText =
                    data.temperature.toFixed(1) + " Â°C";
            }

            if (data.humidity != null) {
                document.getElementById("humidValue").innerText =
                    data.humidity.toFixed(0) + " %";
            }
        }

        // ========= Update Statistics =========
        function updateStats(type, value) {
            if (value == null || isNaN(value)) return;
            
            const stat = stats[type];
            stat.current = value;
            stat.values.push(value);
            
            // Calculate min/max
            stat.min = Math.min(...stat.values);
            stat.max = Math.max(...stat.values);
        }
        
        // ========= Calculate Average =========
        function calculateAverage(values) {
            if (!values || values.length === 0) return 0;
            const sum = values.reduce((a, b) => a + b, 0);
            return sum / values.length;
        }
        
        // ========= Add Point to Chart =========
        function addPoint(time, t, h, skipAnimation = false) {
            labels.push(time);
            tempData.push(t);
            humidData.push(h);
            
            // Keep only last N points for smooth scrolling
            if (labels.length > MAX_CHART_POINTS) {
                labels.shift();
                tempData.shift();
                humidData.shift();
            }
            
            if (chart) {
                // Recalculate ranges for dynamic scaling
                const tempRange = calculateAxisRange(tempData, 1);
                const humidRange = calculateAxisRange(humidData, 5);
                
                // Update chart scales
                chart.options.scales.yTemp.min = tempRange.min;
                chart.options.scales.yTemp.max = tempRange.max;
                chart.options.scales.yHumid.min = humidRange.min;
                chart.options.scales.yHumid.max = humidRange.max;
                
                // Disable animation for real-time updates
                chart.update(skipAnimation ? 'none' : 'default');
            }
        }

        // ========= Calculate Dynamic Min/Max =========
        function calculateAxisRange(data, padding) {
            if (!data || data.length === 0) {
                return { min: 0, max: 100 };
            }
            const min = Math.min(...data);
            const max = Math.max(...data);
            return {
                min: min - padding,
                max: max + padding
            };
        }

        // ========= Initialize Chart =========
        function initChart() {
            const ctx = document.getElementById("sensorChart");

            // Calculate dynamic ranges for Temperature and Humidity
            const tempRange = calculateAxisRange(tempData, 1);
            const humidRange = calculateAxisRange(humidData, 5);

            chart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: "Temperature (Â°C)",
                            data: tempData,
                            borderColor: "#ff4d4d",
                            borderWidth: 3,
                            fill: false,
                            tension: 0.3,
                            yAxisID: "yTemp"
                        },
                        {
                            label: "Humidity (%)",
                            data: humidData,
                            borderColor: "#3399ff",
                            borderWidth: 3,
                            fill: false,
                            tension: 0.3,
                            yAxisID: "yHumid"
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0 // Disable animation for real-time updates
                    },
                    interaction: {
                        mode: "index",
                        intersect: false
                    },
                    scales: {
                        yTemp: {
                            type: "linear",
                            display: true,
                            position: "left",
                            title: {
                                display: true,
                                text: "Temperature (Â°C)",
                                color: "#ff4d4d",
                                font: {
                                    weight: "bold"
                                }
                            },
                            min: tempRange.min,
                            max: tempRange.max,
                            ticks: {
                                color: "#ff4d4d"
                            },
                            grid: {
                                drawOnChartArea: true
                            }
                        },
                        yHumid: {
                            type: "linear",
                            display: true,
                            position: "right",
                            title: {
                                display: true,
                                text: "Humidity (%)",
                                color: "#3399ff",
                                font: {
                                    weight: "bold"
                                }
                            },
                            min: humidRange.min,
                            max: humidRange.max,
                            ticks: {
                                color: "#3399ff"
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: "Time"
                            }
                        }
                    }
                }
            });
        }

        // ========= Load Data =========
        async function bootstrap() {
            try {
                // Load latest sensor data
                const latestRes = await fetch("/api/sensors/latest");

                if (!latestRes.ok) {
                    console.error("Latest API Error:", latestRes.status, latestRes.statusText);
                    throw new Error(`API Error: ${latestRes.status}`);
                }

                const latest = await latestRes.json();
                console.log("Latest API Response:", latest);

                if (latest.success && latest.data) {
                    updateCards(latest.data);
                } else {
                    console.warn("No latest sensor data available:", latest);
                }

                // Load history for chart
                const historyRes = await fetch("/api/sensors?limit=200&order=DESC");

                if (!historyRes.ok) {
                    console.error("History API Error:", historyRes.status, historyRes.statusText);
                    throw new Error(`API Error: ${historyRes.status}`);
                }

                const history = await historyRes.json();
                console.log("History API Response:", history);

                // Add history data first (reverse to show chronological order)
                if (history.success && history.data && history.data.length) {
                    // Reverse array to show oldest to newest
                    const reversedData = [...history.data].reverse();
                    reversedData.forEach(row => {
                        labels.push(new Date(row.measured_at).toLocaleTimeString());
                        tempData.push(row.temperature);
                        humidData.push(row.humidity);
                    });
                } else {
                    console.warn("No history data available:", history);
                }

                // Initialize chart after data is loaded (for dynamic range calculation)
                initChart();
                
                // Initialize stats from loaded data
                tempData.forEach(t => updateStats('temp', t));
                humidData.forEach(h => updateStats('humid', h));
            } catch (error) {
                console.error("Error loading sensor data:", error);
            }
        }
        
        // ========= Socket.IO Real-time Updates =========
        socket.on('connect', () => {
            console.log('[Socket.IO] Connected to server');
        });
        
        socket.on('disconnect', () => {
            console.log('[Socket.IO] Disconnected from server');
        });
        
        socket.on('sensor:update', (data) => {
            // Update current values
            if (data.temperature != null) {
                updateStats('temp', data.temperature);
                document.getElementById("tempValue").innerText = 
                    data.temperature.toFixed(1) + " Â°C";
            }
            
            if (data.humidity != null) {
                updateStats('humid', data.humidity);
                document.getElementById("humidValue").innerText = 
                    data.humidity.toFixed(0) + " %";
            }
            
            // Add point to chart (skip animation for real-time)
            const timeLabel = new Date(data.measured_at).toLocaleTimeString();
            addPoint(timeLabel, data.temperature, data.humidity, true);
            
            console.log('[Socket.IO] Received update:', data);
        });

        // ========= Alert System =========
        socket.on('alert', (alertData) => {
            console.log('[ALERT] Received alert:', alertData);
            
            const { type, value, threshold, level, message } = alertData;
            
            // Play alert sound (if enabled)
            playAlertBeep();
            
            // Show visual alert toast
            const toast = document.getElementById('alertToast');
            const toastTitle = document.getElementById('alertToastTitle');
            const toastMessage = document.getElementById('alertToastMessage');
            
            toastTitle.textContent = level === 'critical' ? 'ğŸ”¥ CRITICAL ALERT' : 'âš ï¸ WARNING';
            toastMessage.innerHTML = `
                <div><strong>${type === 'temperature' ? 'Temperature' : 'Humidity'}:</strong> ${value}${type === 'temperature' ? 'Â°C' : '%'}</div>
                <div><strong>Threshold:</strong> ${threshold}${type === 'temperature' ? 'Â°C' : '%'}</div>
                <div style="margin-top: 8px;">${message}</div>
            `;
            
            // Set toast color based on level
            toast.style.background = level === 'critical' ? '#ff4444' : '#ffaa00';
            toast.style.display = 'block';
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                toast.style.display = 'none';
            }, 10000);
            
            // Highlight affected sensor card
            const cardId = type === 'temperature' ? 'tempCard' : 'humidCard';
            const card = document.getElementById(cardId);
            if (card) {
                card.style.border = `3px solid ${level === 'critical' ? '#ff4444' : '#ffaa00'}`;
                card.style.boxShadow = `0 0 20px ${level === 'critical' ? 'rgba(255, 68, 68, 0.5)' : 'rgba(255, 170, 0, 0.5)'}`;
                
                // Remove highlight after 5 seconds
                setTimeout(() => {
                    card.style.border = '';
                    card.style.boxShadow = '';
                }, 5000);
            }
        });

        // ========= Mute Button =========
        const muteBtn = document.getElementById('muteBtn');
        muteBtn.addEventListener('click', () => {
            soundEnabled = !soundEnabled;
            muteBtn.textContent = soundEnabled ? 'ğŸ”Š Sound: ON' : 'ğŸ”‡ Sound: OFF';
            muteBtn.style.background = soundEnabled ? '#4CAF50' : '#666';
            
            // Sound is controlled by playAlertBeep function
        });

        // Initialize on page load
        bootstrap();
    </script>
</body>

</html>
